
# Домашнее задание №2
Ссылки на файлы (все рассматриваемые файлы находятся в папке `deploy/db`):
- [Все sql-скрипты, запускаемые при инициализации БД](https://github.com/go-park-mail-ru/2025_1_QuickFlow/tree/hw2db/deploy/db/sql)
- [postgresql.conf](https://github.com/go-park-mail-ru/2025_1_QuickFlow/tree/hw2db/deploy/db/postgresql.conf) 
- [docker-compose.yml](https://github.com/go-park-mail-ru/2025_1_QuickFlow/tree/hw2db/deploy/micro-docker-compose.yml)
## Работа с БД через сервисную учетную запись
Поскольку бэкенд-приложение базы данных социальной сети было разделено на несколько сервисов, то для каждого сервиса была создана своя учетная запись в БД.
Каждая сервисная учетная запись имеет свои права доступа к БД, которые определяются в файле `deploy/db/sql/roles.sql`.
Были объявлены следующие роли:
- `community` - роль для сервиса, который отвечает за работу с сообществами. Имеет доступ к таблицам `communities`, `community_user`, `contact_info`;
- `feedback` - роль для сервиса обратной связи. Имеет доступ к таблице `feedback`;
- `messenger` - роль для сервиса мессенджера. Имеет доступ к таблицам `chat`, `chat_user`, `message`, `message_file`;
- `post` - роль для сервиса, который отвечает за работу с постами. Имеет доступ к таблицам `posts`, `post_file`, `like_post`;
- `user` - роль для сервиса, который отвечает за работу с пользователями. Имеет доступ к таблицам `profile`, `school`, `contact_info`, `university`, `faculty`, `education`, `user`.
- `friends` - роль для сервиса, который отвечает за работу с друзьями. Имеет доступ к таблицам `friendship`, доступ к выборке (SELECT) из `user`, `profile`.

Объявленные 5 пользователей обеспечивают независимый и изолированный доступ к необходимым данным в БД, таким образом реализуется принцип "микросервису по базе данных".
Каждый микросервис имеет доступ только к тем данным, которые необходимы для его работы. Это позволяет избежать избыточности данных и повысить безопасность системы.

## Защита от SQL-инъекций
Валидация входных данных поддерживается в приложении с помощью структур-валидаторов, которые реализуют интерфейсы для проверки входных данных (например, длина поста, число картинок в нем и т.д.).
На уровне репозитория используется стандартный пакет `database/sql`, который поддерживает подготовленные запросы (Prepared Statements). Это позволяет избежать SQL-инъекций, так как параметры запроса передаются отдельно от самого запроса с помощью плейсхолдеров `$1`, `$2`, ....
В частности, в репозитории используются методы `ExecContext`, `QueryContext`, `QueryRowContext`, которые принимают на вход контекст, SQL-запрос и параметры запроса. Согласно документации, эти методы используют подготовленные запросы, что делает передачу параметров в них безопасными.

Сервер был протестирован на уязвимости с помощью утилиты `sqlmap`. Файлы asciinema с тестами находятся в папке `deploy/db/tests`. Приложение успешно прошло тестирование.  
POST тест на signup: https://asciinema.org/a/f48OHugoFGrb6KsZTVpt1PqOo  
GET тест на получение рекомендаций: https://asciinema.org/a/KgSgAJz1D0mMjQco0ziukE3E4  
POST тест на посылку фидбека: https://asciinema.org/a/dRxF6XpcoSE7Y7Nr8xQHm5GH6  

## Пул соединений и параметры соединений
Для каждого микросервиса в приложении создается свой пул соединений с общей БД. При этом используются роли, выделенные для каждого микросервиса (описаны выше). 
Пул соединений создается с помощью пакета `database/sql` и драйвера `pgx`. При этом для каждого микросервиса используется ограничение на количество соединений в пуле. Количество соединений в конкретном микросервисе зависит от его нагрузки:
- `community` - 15 соединений - микросервис не является центральным в социальной сети, однако может обрабатывать много незатратных запросов, например, получение информации о сообществе;
- `feedback` - 10 соединений - сбор обратной связи в социальной сети происходит не слишком часто;
- `messenger` - 30 соединений - мессенджер является одним из центральных микросервисов, в каждый момент времени могут переписываться сразу много пользователей. При этом запросы получения сообщений чата могут быть достаточно затратными, но нечастыми. Чаще -- сохранение сообщения в БД (достаточно быстро);
- `friends` - 15 соединений - запросы в друзья и принятие запросов, а также просмотр списка друзей не являются самыми частыми запросами, но требуют больше ресурсов, чем `feedback`;
- `post` - 30 соединений - микросервис постов является одним из центральных в социальной сети. Просмотр ленты и рекомендации - одни из основных операций для пользователей. Запросы к БД при этом могут быть достаточно затратными;
- `user` - 20 соединений - микросервис пользователей является одним из центральных в социальной сети - чаще всего используется для получения информации о пользователе (его профиле), нечасто -- авторизация, изменение профиля. Нагрузка большая, но запросы не тяжелые.

Также в приложении настроен listen_addresses, который определяет, какие адреса слушает сервер СУБД. Поскольку в данный момент все микросервисы приложения запускаются на одном сервере, то в конфигурации указан localhost.

## Настройка параметров сервера и клиента
### Таймауты
Параметры сервера и клиента настраиваются в файле `deploy/db/postgresql.conf`. Для социальной сети важна отзывчивость и скорость ответа, поэтому в конфигурации сервера были выбраны следующие параметры:
- `max_connections` - максимальное количество соединений с сервером. Установлено значение 130, что позволяет одновременно обрабатывать 130 запросов к БД. Такое количество одновременных соединений учитывает возможную нагрузку на сервер со стороны микросервисов, а также оставляет место для подключения администраторов и разработчиков;
- `statement_timeout` - максимальное время выполнения запроса. Установлено значение 3 секунды, позволяющее избежать чрезмерно долгого ожидания ответа от сервера;
- `lock_timeout` - максимальное время ожидания блокировки. Установлено значение 1 секунда, что позволяет избежать долгого ожидания блокировок. В случае DDOS-атак ограничение таймаута позволяет избежать блокировок и зависания сервера;

### Логирование и протоколирование медленных запросов
В файле `deploy/db/postgresql.conf` описаны также параметры логирования и протоколирования медленных запросов. Медленным запросом считается запрос, который выполняется более 0.5 секунды. На хранение логов отводится 100 МБ или 5 дней, после чего логи могут быть перезаписаны.  
Для сбора статистики по запросам используется утилита `pg_stat_statements` и `autoexplain`, которые позволяют собирать статистику по выполненным запросам. Утилиты собирают информацию о количестве вызовов, времени выполнения, количестве строк, которые были возвращены и т.д. Это позволяет находить узкие места в производительности и оптимизировать запросы.


